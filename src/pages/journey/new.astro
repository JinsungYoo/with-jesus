---
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BaseHead from '../../components/BaseHead.astro';

const { session } = Astro.props;
---
<html lang="ko">
  <head>
    <BaseHead title="ìƒˆ ê¸€ ì‘ì„±" description="ê¸€ê³¼ ì´ë¯¸ì§€ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”." />
    <style>
      main {
        max-width: 720px;
        margin: 2rem auto;
        padding: 1rem;
      }
      label {
        display: block;
        margin: 1rem 0 0.3rem;
        font-weight: bold;
      }
      input, textarea {
        width: 100%;
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
      }
      .btn {
        margin-top: 1rem;
        padding: 0.5rem 1.2rem;
        background: var(--accent, #2e7d32);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
      }
      .preview-img {
        margin-top: 1rem;
        max-width: 100%;
        border-radius: 6px;
      }

      /* ì•ˆë‚´ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
      .notice {
        margin: 4rem auto;
        padding: 2rem;
        text-align: center;
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        max-width: 500px;
        font-size: 1.1rem;
      }
    </style>
  </head>
  <body>
    { !session && (
      <>
      <Header />
      <main>
      <div class="notice">ğŸ”’ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...<br />You need to be logged in. Taking you to the login page...</div>
    </main>
    <Footer />
        <script>
          setTimeout(() => {
            window.location.href = "/login";
          }, 2000);
        </script>
        
      </>
    )}

    { session && (
      <>
        <Header />
        <main>
          <h1>âœï¸ ìƒˆ ê¸€ ì‘ì„±</h1>
          <form id="post-form">
            <label>ì œëª©</label>
            <input type="text" name="title" required />

            <label>ë‚´ìš©</label>
            <textarea name="content" rows="6" required></textarea>

            <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
            <input type="file" id="image-upload" accept="image/*" required />
            <img id="image-preview" class="preview-img" style="display: none;" />

            <button type="submit" class="btn">ê²Œì‹œí•˜ê¸°</button>
          </form>
        </main>
        <Footer />

        <script type="module">
          import { supabase } from '../../lib/supabaseClient.js';

          const form = document.getElementById('post-form');
          const imageInput = document.getElementById('image-upload');
          const imagePreview = document.getElementById('image-preview');

          let uploadedImageUrl = '';

          imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = () => {
              imagePreview.src = reader.result;
              imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}.${fileExt}`;

            const { data, error } = await supabase
              .storage
              .from('images')
              .upload(fileName, file);

            if (error) {
              alert(`ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
              console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
              return;
            }

            const { data: urlData } = supabase
              .storage
              .from('images')
              .getPublicUrl(fileName);

            uploadedImageUrl = urlData.publicUrl;
          });

          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = form.title.value;
            const content = form.content.value;

            const { data: userData } = await supabase.auth.getUser();
            const user = userData.user;

            if (!user) {
              alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
              return;
            }

            const { error } = await supabase.from('posts').insert([
              {
                title,
                content,
                image_url: uploadedImageUrl,
                user_id: user.id
              }
            ]);

            if (error) {
              console.error('âŒ ê¸€ ì €ì¥ ì‹¤íŒ¨:', error);
              alert(`ê¸€ ì €ì¥ ì‹¤íŒ¨: ${error.message || '[ì—ëŸ¬ ì •ë³´ ì—†ìŒ]'}`);
            } else {
              alert('âœ… ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
              window.location.href = '/journey';
            }
          });
        </script>
      </>
    )}
  </body>
</html>
